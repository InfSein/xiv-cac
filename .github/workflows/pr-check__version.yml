name: PR Check - Version

on:
  pull_request:
    branches:
      - master
    paths:
      - 'packages/utils/**'
      - 'packages/website/**'

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version bump
        run: |
          # 定义检查函数
          check_version_bump() {
            local pkg_path=$1
            local pkg_name=$2
            
            echo "Checking changes for $pkg_name in $pkg_path..."
            
            # 检查目录下是否有变动
            DIFF=$(git diff --name-only origin/master...HEAD -- "$pkg_path")
            if [ -z "$DIFF" ]; then
              echo "No changes in $pkg_path, skipping."
              return 0
            fi
            
            # 检查 package.json 是否已修改
            if ! echo "$DIFF" | grep -q "$pkg_path/package.json"; then
              echo "::error::Changes detected in $pkg_path but version was not bumped in $pkg_path/package.json"
              exit 1
            fi
            
            # 检查版本号是否真的增加了
            VERSION_OLD=$(git show origin/master:"$pkg_path/package.json" 2>/dev/null | jq -r .version || echo "0.0.0")
            VERSION_NEW=$(jq -r .version "$pkg_path/package.json")
            
            if [ "$VERSION_OLD" == "$VERSION_NEW" ]; then
              echo "::error::Version in $pkg_path/package.json must be bumped (Current: $VERSION_OLD)"
              exit 1
            fi
            
            echo "Version bump detected for $pkg_name: $VERSION_OLD -> $VERSION_NEW"
          }

          # 执行检查
          check_version_bump "packages/utils" "xiv-cac-utils"
          check_version_bump "packages/website" "xiv-cac-website"
